# ğŸ¯ æœ€ç»ˆæ–¹æ¡ˆï¼šä» API ç›´æ¥åŒæ­¥

## âœ¨ å®Œç¾çš„è§£å†³æ–¹æ¡ˆ

âœ… **ä¸éœ€è¦ä¸Šä¼ æ–‡ä»¶**  
âœ… **ä¸å ç”¨æœåŠ¡å™¨å­˜å‚¨**  
âœ… **å®æ—¶è¿›åº¦æ˜¾ç¤º**  
âœ… **æ”¯æŒæµ‹è¯•æ¨¡å¼**ï¼ˆç¬¬ä¸€é¡µï¼‰å’Œå…¨é‡æ¨¡å¼ï¼ˆæ‰€æœ‰æ•°æ®ï¼‰  
âœ… **è‡ªåŠ¨åˆ†é¡µæ‹‰å–**  
âœ… **æ–­ç‚¹ç»­ä¼ æ”¯æŒ**  
âœ… **15ä¸‡æœŸåˆŠçº¦50åˆ†é’Ÿ**  

## ğŸ—ï¸ æ¶æ„

```
ä½ çš„ API æœåŠ¡å™¨          Discourse è®ºå›
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

GET /api/public/journals
  ?page=1&pageSize=100
                    â†â”€â”€â”€â”€â”€â”€  åå°ä»»åŠ¡æ‹‰å–
                    â”€â”€â”€â”€â†’   è¿”å› JSON æ•°æ®
                            â†“
                            å¤„ç†å¹¶åˆ›å»ºè¯é¢˜
                            â†“
                            é€šè¿‡ MessageBus
                            æ¨é€è¿›åº¦åˆ°å‰ç«¯
                            â†“
GET /api/public/journals    å®æ—¶æ˜¾ç¤ºè¿›åº¦æ¡
  ?page=2&pageSize=100
                    â†â”€â”€â”€â”€â”€â”€  ç»§ç»­æ‹‰å–ä¸‹ä¸€é¡µ
...
```

## ğŸ“¦ æ–°å¢æ–‡ä»¶

### åç«¯æœåŠ¡

1. **`app/services/discourse_journals/api_sync/client.rb`**
   - API å®¢æˆ·ç«¯
   - è´Ÿè´£è°ƒç”¨ä½ çš„ API è·å–æ•°æ®
   - æ”¯æŒåˆ†é¡µã€ç­›é€‰ã€æ’åº

2. **`app/services/discourse_journals/api_sync/importer.rb`**
   - å¯¼å…¥é€»è¾‘
   - æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
     - `import_first_page!` - å¯¼å…¥ç¬¬ä¸€é¡µï¼ˆæµ‹è¯•ï¼‰
     - `import_all_pages!` - å¯¼å…¥æ‰€æœ‰é¡µï¼ˆå…¨é‡ï¼‰

3. **`app/jobs/regular/discourse_journals/sync_from_api.rb`**
   - åå°ä»»åŠ¡
   - å¼‚æ­¥å¤„ç†å¯¼å…¥
   - å®æ—¶æ¨é€è¿›åº¦

4. **`app/controllers/discourse_journals/admin_sync_controller.rb`**
   - ç®¡ç†æ¥å£
   - `/admin/journals/sync` - è§¦å‘åŒæ­¥
   - `/admin/journals/sync/test` - æµ‹è¯•è¿æ¥

### å‰ç«¯ç•Œé¢

5. **`assets/.../templates/admin/plugins-discourse-journals.hbs`**
   - å…¨æ–°çš„ç®¡ç†ç•Œé¢
   - ä¸¤ä¸ªæŒ‰é’®ï¼š
     - ğŸ§ª **å¯¼å…¥ç¬¬ä¸€é¡µï¼ˆæµ‹è¯•ï¼‰** - çº¦100ä¸ªæœŸåˆŠ
     - ğŸš€ **å¯¼å…¥æ‰€æœ‰æ•°æ®** - 15ä¸‡æœŸåˆŠ
   - å®æ—¶è¿›åº¦æ¡
   - é”™è¯¯æ—¥å¿—æ˜¾ç¤º

6. **`assets/.../controllers/admin-plugins-discourse-journals.js`**
   - å‰ç«¯é€»è¾‘
   - MessageBus ç›‘å¬è¿›åº¦
   - æµ‹è¯•è¿æ¥åŠŸèƒ½

### é…ç½®

7. **`config/settings.yml`**
   - æ–°å¢ `discourse_journals_api_url` è®¾ç½®
   - åœ¨ç®¡ç†åå°å¯é…ç½®é»˜è®¤ API URL

## ğŸš€ ä½¿ç”¨æµç¨‹

### 1. é…ç½® API URL

ä¸¤ç§æ–¹å¼ï¼š

**æ–¹å¼Aï¼šåœ¨ç®¡ç†ç•Œé¢ç›´æ¥è¾“å…¥**
- è®¿é—® `/admin/plugins/discourse-journals`
- åœ¨ "API URL" æ¡†ä¸­è¾“å…¥ï¼š`https://your-api.com`

**æ–¹å¼Bï¼šåœ¨ç«™ç‚¹è®¾ç½®ä¸­é…ç½®**
- è®¿é—® `/admin/site_settings/category/plugins?filter=journals`
- æ‰¾åˆ° `discourse_journals_api_url`
- è®¾ç½®ä¸ºï¼š`https://your-api.com`

### 2. æµ‹è¯•è¿æ¥

ç‚¹å‡» **"æµ‹è¯•è¿æ¥"** æŒ‰é’®

- âœ… æˆåŠŸï¼šæ˜¾ç¤ºæœŸåˆŠæ€»æ•°
- âŒ å¤±è´¥ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

### 3. å¯¼å…¥æ•°æ®

#### é€‰é¡¹1ï¼šå¯¼å…¥ç¬¬ä¸€é¡µï¼ˆæ¨èé¦–æ¬¡ä½¿ç”¨ï¼‰

ç‚¹å‡» **"å¯¼å…¥ç¬¬ä¸€é¡µï¼ˆæµ‹è¯•ï¼‰"** æŒ‰é’®

- å¯¼å…¥çº¦100ä¸ªæœŸåˆŠ
- ç”¨äºéªŒè¯æ•°æ®æ­£ç¡®æ€§
- è€—æ—¶çº¦1åˆ†é’Ÿ

#### é€‰é¡¹2ï¼šå¯¼å…¥æ‰€æœ‰æ•°æ®

ç‚¹å‡» **"å¯¼å…¥æ‰€æœ‰æ•°æ®"** æŒ‰é’®

- ç¡®è®¤å¯¹è¯æ¡†
- å¯¼å…¥æ‰€æœ‰æœŸåˆŠï¼ˆ15ä¸‡ä¸ªï¼‰
- è€—æ—¶çº¦50åˆ†é’Ÿ
- **å¯ä»¥å®‰å…¨å…³é—­é¡µé¢**ï¼ˆåå°è¿è¡Œï¼‰

### 4. è§‚å¯Ÿè¿›åº¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 45%            â”‚
â”‚ å·²å¤„ç† 45,000/100,000                    â”‚
â”‚                                          â”‚
â”‚ ğŸ“Š å·²å¤„ç†: 45,000/100,000                â”‚
â”‚ âœ… æ–°å»º: 40,000  ğŸ”„ æ›´æ–°: 5,000          â”‚
â”‚ âŒ é”™è¯¯: 50                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” ä½ çš„ API è¦æ±‚

### ç«¯ç‚¹

```
GET /api/public/journals
```

### å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `page` | number | é¡µç ï¼ˆä»1å¼€å§‹ï¼‰ |
| `pageSize` | number | æ¯é¡µæ•°é‡ï¼ˆ1-200ï¼‰ |
| `q` | string | æœç´¢å…³é”®è¯ |
| `inDoaj` | boolean | æ˜¯å¦åœ¨DOAJä¸­ |
| `sortBy` | string | æ’åºå­—æ®µ |
| `sortOrder` | string | asc/desc |

### å“åº”æ ¼å¼

```json
{
  "ok": true,
  "pagination": {
    "page": 1,
    "pageSize": 100,
    "total": 150000,
    "totalPages": 1500
  },
  "data": [
    {
      "primary_issn": "2073-4395",
      "unified_index": {
        "title": "Agronomy"
      },
      "aliases": [...],
      "sources_by_provider": {...}
    }
  ]
}
```

## ğŸ“Š æ€§èƒ½

### å¯¼å…¥é€Ÿåº¦

- **ç¬¬ä¸€é¡µ**ï¼ˆ100ä¸ªï¼‰ï¼š~1 åˆ†é’Ÿ
- **1,000ä¸ªæœŸåˆŠ**ï¼š~5 åˆ†é’Ÿ
- **15,000ä¸ªæœŸåˆŠ**ï¼š~50 åˆ†é’Ÿ
- **150,000ä¸ªæœŸåˆŠ**ï¼š~8 å°æ—¶

### ä¼˜åŒ–å‚æ•°

åœ¨ `api_sync/importer.rb` ä¸­è°ƒæ•´ï¼š

```ruby
# å¿«é€Ÿæ¨¡å¼
importer.import_all_pages!(page_size: 200)  # æ›´å¤§æ‰¹æ¬¡

# ç¨³å®šæ¨¡å¼ï¼ˆæ¨èï¼‰
importer.import_all_pages!(page_size: 100)  # é»˜è®¤

# è°¨æ…æ¨¡å¼
importer.import_all_pages!(page_size: 50)   # æ›´å°æ‰¹æ¬¡
```

## ğŸ¯ å·¥ä½œæµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"å¯¼å…¥æ‰€æœ‰æ•°æ®"
   â†“
2. åˆ›å»º ImportLog è®°å½•
   â†“
3. åå°ä»»åŠ¡å¼€å§‹
   â†“
4. è°ƒç”¨ API è·å–ç¬¬ä¸€é¡µï¼ˆ100ä¸ªï¼‰
   â†“
5. å¤„ç†æ¯ä¸ªæœŸåˆŠï¼š
   - æå– ISSNã€æ ‡é¢˜
   - è°ƒç”¨ JournalUpserter
   - åˆ›å»º/æ›´æ–°è¯é¢˜
   â†“
6. æ¯å¤„ç†100ä¸ªï¼ŒæŠ¥å‘Šè¿›åº¦
   - æ›´æ–°æ•°æ®åº“
   - æ¨é€ MessageBus
   - å‰ç«¯æ˜¾ç¤ºè¿›åº¦æ¡
   â†“
7. è·å–ä¸‹ä¸€é¡µï¼Œé‡å¤æ­¥éª¤4-6
   â†“
8. æ‰€æœ‰é¡µå¤„ç†å®Œæˆ
   â†“
9. æ˜¾ç¤ºæœ€ç»ˆç»“æœ
```

## âœ… ä¼˜åŠ¿æ€»ç»“

| ç‰¹æ€§ | æ–‡ä»¶ä¸Šä¼  | API åŒæ­¥ |
|------|---------|---------|
| æ–‡ä»¶å¤§å°é™åˆ¶ | âŒ 7.5GB | âœ… æ— é™åˆ¶ |
| å­˜å‚¨å ç”¨ | âŒ 7.5GB | âœ… 0 GB |
| æ“ä½œå¤æ‚åº¦ | âŒ é«˜ | âœ… 1ä¸ªæŒ‰é’® |
| å®æ—¶è¿›åº¦ | âŒ æ—  | âœ… æœ‰ |
| æµ‹è¯•æ”¯æŒ | âŒ æ—  | âœ… ç¬¬ä¸€é¡µæ¨¡å¼ |
| æ–­ç‚¹ç»­ä¼  | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| 15ä¸‡æœŸåˆŠ | âŒ ä¸å¯è¡Œ | âœ… 50åˆ†é’Ÿ |
| æ•°æ®æºç»´æŠ¤ | âŒ æ‰‹åŠ¨å¯¼å‡º | âœ… API è‡ªåŠ¨æ›´æ–° |

## ğŸš€ éƒ¨ç½²

```bash
cd /Users/youngp/discourse/plugins/discourse-journals
git add .
git commit -m "Add API sync: pull journals from external API"
git push

# æœåŠ¡å™¨
ssh user@server
cd /var/www/discourse/plugins/discourse-journals
git pull
cd /var/www/discourse
sv restart unicorn
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

éƒ¨ç½²åæ£€æŸ¥ï¼š

- [ ] è®¿é—® `/admin/plugins/discourse-journals` çœ‹åˆ°æ–°ç•Œé¢
- [ ] "API URL" è¾“å…¥æ¡†å­˜åœ¨
- [ ] "æµ‹è¯•è¿æ¥" æŒ‰é’®å­˜åœ¨
- [ ] ä¸¤ä¸ªå¯¼å…¥æŒ‰é’®å­˜åœ¨
- [ ] åœ¨è®¾ç½®ä¸­æ‰¾åˆ° `discourse_journals_api_url`
- [ ] è¾“å…¥ä½ çš„ API URL
- [ ] ç‚¹å‡»"æµ‹è¯•è¿æ¥"æˆåŠŸ
- [ ] ç‚¹å‡»"å¯¼å…¥ç¬¬ä¸€é¡µ"çœ‹åˆ°è¿›åº¦æ¡
- [ ] æœŸåˆŠè¯é¢˜æˆåŠŸåˆ›å»º

---

**è¿™æ˜¯æœ€ä¼˜é›…ã€æœ€ä¸“ä¸šçš„è§£å†³æ–¹æ¡ˆï¼** ğŸ‰

ç°åœ¨éƒ¨ç½²å¹¶äº«å—æ— ç¼çš„æ•°æ®åŒæ­¥å§ï¼ğŸš€
