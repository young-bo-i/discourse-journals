# 🚀 快速开始：API 同步方案

## 🎯 最终方案

**从你的 API 直接拉取期刊数据，不需要任何文件！**

```
你的 API              Discourse
────────              ─────────
                          │
GET /api/public/journals  │
  ?page=1             ←───┤ 拉取数据
                      ───→│ 
                          │ 处理并创建话题
                          │ 
                          │ 实时显示进度
GET /api/public/journals  │
  ?page=2             ←───┤ 继续拉取
...
```

## ⚡ 3 步部署

### 1️⃣ 部署代码（5分钟）

```bash
cd /Users/youngp/discourse/plugins/discourse-journals
git add .
git commit -m "Add API sync functionality"
git push

# SSH 到服务器
ssh user@server
cd /var/www/discourse/plugins/discourse-journals
git pull
cd /var/www/discourse
sv restart unicorn
```

### 2️⃣ 配置 API URL（1分钟）

访问 `/admin/plugins/discourse-journals`

输入你的 API URL：
```
https://your-api.com
```

点击 **"测试连接"**，确认成功。

### 3️⃣ 开始导入（1分钟操作 + 后台运行）

#### 首次使用（推荐）

点击 **"导入第一页（测试）"**
- 导入约100个期刊
- 验证数据正确性
- 耗时约1分钟

#### 全量导入

点击 **"导入所有数据"**
- 15万期刊约50分钟
- 后台运行，可以关闭页面

## 🎨 界面预览

```
┌─────────────────────────────────────────────┐
│ 从 API 同步期刊数据                          │
├─────────────────────────────────────────────┤
│                                             │
│ API URL                                     │
│ [https://your-api.com              ]        │
│                                             │
│ [测试连接]                                  │
│ ✅ API 连接成功！共 150,000 个期刊           │
│                                             │
│ 导入选项                                     │
│ ┌──────────────┐  ┌──────────────────┐     │
│ │🧪 导入第一页  │  │🚀 导入所有数据    │     │
│ │（测试）      │  │                  │     │
│ └──────────────┘  └──────────────────┘     │
│                                             │
│ ████████████░░░░░░░░░ 60%                  │
│ 已处理 90,000/150,000                       │
│                                             │
│ 📊 已处理: 90,000/150,000                   │
│ ✅ 新建: 85,000  🔄 更新: 5,000             │
│ ❌ 错误: 100                                │
└─────────────────────────────────────────────┘
```

## 📋 你的 API 要求

### 必须实现的端点

```
GET /api/public/journals?page=1&pageSize=100
```

### 必须返回的格式

```json
{
  "ok": true,
  "pagination": {
    "page": 1,
    "pageSize": 100,
    "total": 150000,
    "totalPages": 1500
  },
  "data": [
    {
      "primary_issn": "2073-4395",
      "unified_index": {
        "title": "Agronomy"
      },
      "aliases": [],
      "sources_by_provider": {
        "openalex": { "data": {...} },
        "crossref": { "data": {...} },
        "doaj": { "data": {...} },
        "nlm": { "data": {...} },
        "wikidata": { "data": {...} }
      }
    }
  ]
}
```

### 重要字段

| 字段 | 必填 | 说明 |
|------|------|------|
| `ok` | ✅ | 必须为 `true` |
| `pagination.total` | ✅ | 总记录数 |
| `pagination.totalPages` | ✅ | 总页数 |
| `data` | ✅ | 期刊数组 |
| `data[].primary_issn` | ✅ | 主 ISSN |
| `data[].unified_index.title` | ✅ | 标题 |

## ⚡ 性能预估

| 数据量 | 耗时 | 说明 |
|--------|------|------|
| 100 个（第一页） | ~1分钟 | 测试模式 |
| 1,000 个 | ~5分钟 | 小型期刊库 |
| 15,000 个 | ~50分钟 | 中型期刊库 |
| 150,000 个 | ~8小时 | 大型期刊库 |

## 🎯 使用场景

### 场景1：首次导入

```
1. 配置 API URL
2. 测试连接
3. 导入第一页（验证）
4. 检查创建的话题
5. 导入所有数据
```

### 场景2：定期更新

```
1. 访问管理页面
2. 点击"导入所有数据"
3. 自动更新已存在的期刊
4. 添加新增的期刊
```

### 场景3：增量同步

你的 API 可以支持：
```
GET /api/public/journals?updatedAfter=2026-01-01
```

然后只同步更新的期刊。

## 🔍 故障排查

### 问题1：测试连接失败

**检查**：
- API URL 是否正确
- API 是否可访问
- 网络连接是否正常

**测试**：
```bash
curl https://your-api.com/api/public/journals?page=1&pageSize=1
```

### 问题2：导入卡住

**检查**：
- 查看服务器日志
- 确认后台任务在运行
- 检查 Sidekiq 队列

**命令**：
```bash
tail -f /var/www/discourse/log/production.log | grep DiscourseJournals
```

### 问题3：部分期刊失败

**检查**：
- 点击"显示错误"查看错误日志
- 常见原因：
  - 缺少 `primary_issn`
  - 缺少 `title`
  - JSON 格式不正确

## 💡 最佳实践

1. **首次导入前**：
   - 先测试第一页
   - 检查创建的话题格式
   - 确认数据正确

2. **全量导入时**：
   - 选择服务器负载低的时间
   - 可以关闭浏览器（后台运行）
   - 定期检查进度

3. **定期更新**：
   - 建议每周或每月同步一次
   - 自动更新已存在的期刊
   - 添加新增的期刊

## ✅ 优势

- ✅ **零文件**：不需要上传任何文件
- ✅ **零存储**：不占用服务器存储空间
- ✅ **实时同步**：直接从你的 API 拉取最新数据
- ✅ **可测试**：支持第一页测试模式
- ✅ **可监控**：实时进度显示
- ✅ **易维护**：数据源由你的 API 维护
- ✅ **可扩展**：支持任意数量的期刊

---

## 🎉 完成！

现在你有了一个完美的解决方案：

1. ✅ 不需要上传 7.5 GB 文件
2. ✅ 不需要拆分150个小文件
3. ✅ 不需要占用服务器存储
4. ✅ 一个按钮搞定15万期刊
5. ✅ 实时进度显示
6. ✅ 自动错误处理

**立即部署并享受无缝的数据同步！** 🚀

查看 `API_SYNC_SOLUTION.md` 了解技术细节。
