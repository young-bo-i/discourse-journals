<div class="admin-container journals-admin-page">
  <h2>{{i18n "discourse_journals.admin.heading"}}</h2>

  <div class="journals-sync-section">
    <h3>ä» API åŒæ­¥æœŸåˆŠæ•°æ®</h3>

    <div class="sync-config">
      <div class="control-group">
        <label class="control-label">API URL</label>
        <div class="controls">
          <input
            type="text"
            {{on "input" this.updateApiUrl}}
            value={{this.apiUrl}}
            placeholder="https://api.example.com"
            class="api-url-input"
          />
          <p class="help-text">
            å¯ä»¥åœ¨
            <a href="/admin/site_settings/category/plugins?filter=journals">ç«™ç‚¹è®¾ç½®</a>
            ä¸­é…ç½®é»˜è®¤ API URL
          </p>
        </div>
      </div>

      <div class="control-group">
        <div class="controls">
          <DButton
            @class="btn-default"
            @action={{action "testConnection"}}
            @label="æµ‹è¯•è¿æ¥"
            @icon="plug"
            @isLoading={{this.testing}}
            @disabled={{this.syncing}}
          />
          
          <DButton
            @class="btn-default"
            @action={{action "toggleFilters"}}
            @label={{if this.showFilters "éšè—ç­›é€‰" "æ˜¾ç¤ºç­›é€‰"}}
            @icon="filter"
            @disabled={{this.syncing}}
          />
        </div>
        {{#if this.testMessage}}
          <div class="alert {{if this.testSuccess 'alert-success' 'alert-error'}}">
            {{this.testMessage}}
          </div>
        {{/if}}
      </div>

      {{#if this.showFilters}}
        <div class="filters-section">
          <h4>ç­›é€‰æ¡ä»¶</h4>
          
          <div class="filters-grid">
            <div class="filter-item">
              <label>æœç´¢å…³é”®è¯</label>
              <input
                type="text"
                {{on "input" this.updateFilterQ}}
                value={{this.filterQ}}
                placeholder="æœç´¢ ISSNã€æ ‡é¢˜ã€å‡ºç‰ˆå•†..."
              />
            </div>

            <div class="filter-item">
              <label>æ˜¯å¦åœ¨ DOAJ ä¸­</label>
              <select {{on "change" this.updateFilterInDoaj}} value={{this.filterInDoaj}}>
                <option value="">å…¨éƒ¨</option>
                <option value="true">æ˜¯</option>
                <option value="false">å¦</option>
              </select>
            </div>

            <div class="filter-item">
              <label>æ˜¯å¦åœ¨ NLM ä¸­</label>
              <select {{on "change" this.updateFilterInNlm}} value={{this.filterInNlm}}>
                <option value="">å…¨éƒ¨</option>
                <option value="true">æ˜¯</option>
                <option value="false">å¦</option>
              </select>
            </div>

            <div class="filter-item">
              <label>æ˜¯å¦æœ‰ Wikidata</label>
              <select {{on "change" this.updateFilterHasWikidata}} value={{this.filterHasWikidata}}>
                <option value="">å…¨éƒ¨</option>
                <option value="true">æ˜¯</option>
                <option value="false">å¦</option>
              </select>
            </div>

            <div class="filter-item">
              <label>æ˜¯å¦å¼€æ”¾è·å–</label>
              <select {{on "change" this.updateFilterIsOpenAccess}} value={{this.filterIsOpenAccess}}>
                <option value="">å…¨éƒ¨</option>
                <option value="true">æ˜¯</option>
                <option value="false">å¦</option>
              </select>
            </div>
          </div>

          <div class="filter-actions">
            <DButton
              @class="btn-default"
              @action={{action "clearFilters"}}
              @label="æ¸…é™¤ç­›é€‰"
              @icon="times"
            />
            
            <span class="filter-info">
              {{#if this.hasActiveFilters}}
                âœ… å·²åº”ç”¨ {{this.activeFiltersCount}} ä¸ªç­›é€‰æ¡ä»¶
              {{else}}
                æš‚æ— ç­›é€‰æ¡ä»¶
              {{/if}}
            </span>
          </div>
        </div>
      {{/if}}
    </div>

    <div class="sync-actions">
      <h4>å¯¼å…¥é€‰é¡¹</h4>

      <div class="action-buttons">
        <div class="action-item">
          <DButton
            @class="btn-primary"
            @action={{action "syncFirstPage"}}
            @label="å¯¼å…¥ç¬¬ä¸€é¡µï¼ˆæµ‹è¯•ï¼‰"
            @icon="download"
            @isLoading={{this.syncing}}
            @disabled={{this.syncing}}
          />
          <p class="action-description">ä»…å¯¼å…¥ç¬¬ä¸€é¡µæ•°æ®ï¼ˆçº¦100ä¸ªæœŸåˆŠï¼‰ï¼Œç”¨äºæµ‹è¯•</p>
        </div>

        <div class="action-item">
          <DButton
            @class="btn-danger"
            @action={{action "syncAllPages"}}
            @label="å¯¼å…¥æ‰€æœ‰æ•°æ®"
            @icon="cloud-download-alt"
            @isLoading={{this.syncing}}
            @disabled={{this.syncing}}
          />
          <p class="action-description">
            å¯¼å…¥æ‰€æœ‰æœŸåˆŠæ•°æ®ï¼ˆå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰
          </p>
        </div>
      </div>
    </div>

    {{! è¿›åº¦æ¡ }}
    {{#if this.showProgress}}
      <div class="import-progress">
        <div class="progress-bar-container">
          <div class="progress-bar" style="width: {{this.progress}}%">
            <span class="progress-text">{{this.progress}}%</span>
          </div>
        </div>
        <p class="progress-message">{{this.progressMessage}}</p>

        {{#if this.importStats}}
          <div class="import-stats">
            <span class="stat">
              ğŸ“Š å·²å¤„ç†:
              {{this.importStats.processed}}/{{this.importStats.total}}
            </span>
            <span class="stat">âœ… æ–°å»º: {{this.importStats.created}}</span>
            <span class="stat">ğŸ”„ æ›´æ–°: {{this.importStats.updated}}</span>
            {{#if (gt this.importStats.errors 0)}}
              <span class="stat error">âŒ é”™è¯¯:
                {{this.importStats.errors}}</span>
            {{/if}}
          </div>
        {{/if}}
      </div>
    {{/if}}

    {{! ç»“æœæ¶ˆæ¯ }}
    {{#if this.importMessage}}
      <div class="alert {{if this.importSuccess 'alert-success' 'alert-error'}}">
        {{this.importMessage}}
      </div>
    {{/if}}

    {{! é”™è¯¯æ—¥å¿— }}
    {{#if (gt this.errors.length 0)}}
      <div class="import-errors">
        <div class="errors-header">
          <h4>âŒ é”™è¯¯æ—¥å¿— ({{this.errors.length}})</h4>
          <div class="errors-actions">
            <DButton
              @action={{action "toggleErrors"}}
              @label={{if this.showErrors "éšè—é”™è¯¯" "æ˜¾ç¤ºé”™è¯¯"}}
              @icon={{if this.showErrors "chevron-up" "chevron-down"}}
            />
            <DButton
              @action={{action "copyErrors"}}
              @label="å¤åˆ¶é”™è¯¯æ—¥å¿—"
              @icon="copy"
            />
          </div>
        </div>

        {{#if this.showErrors}}
          <div class="errors-list">
            {{#each this.errors as |error index|}}
              <div class="error-item">
                <div class="error-message">
                  <strong>{{add index 1}}.</strong>
                  {{error.message}}
                </div>
                {{#if error.details}}
                  <pre class="error-details">{{error.details}}</pre>
                {{/if}}
              </div>
            {{/each}}
          </div>
        {{/if}}
      </div>
    {{/if}}

    <div class="alert alert-info" style="margin-top: 20px;">
      <p>ğŸ’¡ æç¤ºï¼š</p>
      <ul>
        <li>é¦–æ¬¡å¯¼å…¥å»ºè®®å…ˆæµ‹è¯•ç¬¬ä¸€é¡µï¼Œç¡®è®¤æ•°æ®æ­£ç¡®åå†å¯¼å…¥å…¨éƒ¨</li>
        <li>å¯¼å…¥è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨åˆ›å»ºæˆ–æ›´æ–°æœŸåˆŠè¯é¢˜</li>
        <li>é‡å¤å¯¼å…¥ä¼šæ›´æ–°å·²å­˜åœ¨çš„æœŸåˆŠï¼Œä¸ä¼šåˆ›å»ºé‡å¤è¯é¢˜</li>
        <li>å¯¼å…¥åœ¨åå°è¿è¡Œï¼Œå¯ä»¥å®‰å…¨å…³é—­æ­¤é¡µé¢</li>
      </ul>
    </div>
  </div>
</div>

<style>
  .journals-admin-page {
    max-width: 900px;
  }

  .journals-sync-section {
    background: var(--primary-very-low);
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
  }

  .sync-config {
    margin-bottom: 30px;
  }

  .api-url-input {
    width: 100%;
    max-width: 500px;
  }

  .help-text {
    color: var(--primary-medium);
    font-size: 0.9em;
    margin-top: 5px;
  }

  .sync-actions {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--primary-low);
  }

  .action-buttons {
    display: flex;
    gap: 20px;
    margin-top: 15px;
  }

  .action-item {
    flex: 1;
    padding: 15px;
    background: var(--secondary);
    border-radius: 6px;
    border: 1px solid var(--primary-low);
  }

  .action-description {
    margin-top: 10px;
    font-size: 0.9em;
    color: var(--primary-medium);
  }

  .filters-section {
    margin-top: 20px;
    padding: 20px;
    background: var(--secondary);
    border-radius: 6px;
    border: 1px solid var(--primary-low);
  }

  .filters-section h4 {
    margin-top: 0;
    margin-bottom: 15px;
    color: var(--primary);
  }

  .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
  }

  .filter-item {
    display: flex;
    flex-direction: column;
  }

  .filter-item label {
    margin-bottom: 5px;
    font-weight: 500;
    font-size: 0.9em;
    color: var(--primary-high);
  }

  .filter-item input,
  .filter-item select {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid var(--primary-low);
    border-radius: 4px;
    background: var(--secondary);
    color: var(--primary);
  }

  .filter-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 15px;
    border-top: 1px solid var(--primary-low);
  }

  .filter-info {
    font-size: 0.9em;
    color: var(--primary-medium);
  }

  .import-progress {
    margin: 20px 0;
    padding: 15px;
    background: var(--secondary);
    border-radius: 6px;
    border: 1px solid var(--primary-low);
  }

  .progress-bar-container {
    width: 100%;
    height: 30px;
    background: var(--primary-very-low);
    border-radius: 15px;
    overflow: hidden;
    position: relative;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--tertiary), var(--success));
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 50px;
  }

  .progress-text {
    color: white;
    font-weight: bold;
    font-size: 14px;
  }

  .progress-message {
    margin-top: 10px;
    font-size: 14px;
    color: var(--primary-high);
  }

  .import-stats {
    display: flex;
    gap: 15px;
    margin-top: 10px;
    flex-wrap: wrap;
  }

  .import-stats .stat {
    padding: 5px 10px;
    background: var(--primary-very-low);
    border-radius: 4px;
    font-size: 13px;
  }

  .import-stats .stat.error {
    background: var(--danger-low);
    color: var(--danger);
  }

  .import-errors {
    margin-top: 20px;
    padding: 15px;
    background: var(--danger-low);
    border: 1px solid var(--danger);
    border-radius: 6px;
  }

  .errors-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .errors-header h4 {
    margin: 0;
    color: var(--danger);
  }

  .errors-actions {
    display: flex;
    gap: 10px;
  }

  .errors-list {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 15px;
  }

  .error-item {
    padding: 10px;
    margin-bottom: 10px;
    background: var(--secondary);
    border-radius: 4px;
    border-left: 3px solid var(--danger);
  }

  .error-message {
    color: var(--primary);
    margin-bottom: 5px;
  }

  .error-details {
    margin: 8px 0 0 0;
    padding: 8px;
    background: var(--primary-very-low);
    border-radius: 3px;
    font-size: 12px;
    color: var(--primary-medium);
    overflow-x: auto;
  }
</style>
