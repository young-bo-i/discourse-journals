<div class="admin-container journals-admin-page">
  <div class="journals-header">
    <h2>{{i18n "discourse_journals.admin.heading"}}</h2>
    <p class="journals-subtitle">{{i18n
        "discourse_journals.admin.subtitle"
      }}</p>
  </div>

  <div class="journals-main">
    {{! ═══ Phase 1: 映射分析 ═══ }}
    <section class="journals-section mapping-section">
      <div class="section-header">
        <h3>{{i18n "discourse_journals.admin.mapping.heading"}}</h3>
        <div class="header-actions">
          {{#if this.analyzing}}
            <DButton
              @class="btn-danger"
              @action={{action "pauseMappingAnalysis"}}
              @label="discourse_journals.admin.mapping.pause"
              @icon="pause"
              @isLoading={{this.analysisPausing}}
              @disabled={{this.analysisPausing}}
            />
          {{else}}
            <DButton
              @class="btn-primary"
              @action={{action "startMappingAnalysis"}}
              @label="discourse_journals.admin.mapping.start"
              @icon="exchange-alt"
              @disabled={{this.analyzing}}
            />
            {{#if
              (or this.analysisPaused this.analysisFailed this.analysisResult)
            }}
              <DButton
                @class="btn-default"
                @action={{action "restartMappingAnalysis"}}
                @label="discourse_journals.admin.mapping.restart"
                @icon="redo"
              />
            {{/if}}
          {{/if}}
        </div>
      </div>

      <div class="section-content">
        <p class="mapping-desc">{{i18n
            "discourse_journals.admin.mapping.description"
          }}</p>

        {{! 分析进行中 }}
        {{#if this.analyzing}}
          <div class="mapping-progress">
            <div class="progress-container">
              <div class="progress-track">
                <div
                  class="progress-fill"
                  style="width: {{this.analysisProgress}}%"
                ></div>
              </div>
              <span class="progress-percent">{{this.analysisProgress}}%</span>
            </div>
            <p class="progress-status">{{this.analysisMessage}}</p>
          </div>
        {{/if}}

        {{! 分析失败 }}
        {{#if this.analysisFailed}}
          <div class="mapping-failed-panel">
            <div class="mapping-progress">
              <div class="progress-container">
                <div class="progress-track">
                  <div
                    class="progress-fill progress-fill-error"
                    style="width: {{this.analysisProgress}}%"
                  ></div>
                </div>
                <span class="progress-percent">{{this.analysisProgress}}%</span>
              </div>
            </div>
            <div class="message-box message-error">
              <span class="error-icon">&#x26A0;</span>
              <div class="error-content">
                <strong>{{i18n
                    "discourse_journals.admin.mapping.analysis_error_title"
                  }}</strong>
                <p>{{this.analysisMessage}}</p>
              </div>
            </div>
            <p class="mapping-failed-hint">{{i18n
                "discourse_journals.admin.mapping.analysis_error_hint"
              }}</p>
          </div>
        {{/if}}

        {{! 分析已暂停 }}
        {{#if this.analysisPaused}}
          <div class="mapping-paused-panel">
            <div class="mapping-progress">
              <div class="progress-container">
                <div class="progress-track">
                  <div
                    class="progress-fill progress-fill-paused"
                    style="width: {{this.analysisProgress}}%"
                  ></div>
                </div>
                <span class="progress-percent">{{this.analysisProgress}}%</span>
              </div>
            </div>
            <div class="message-box message-warning">
              <span class="paused-icon">&#x23F8;</span>
              <div class="paused-content">
                <strong>{{i18n
                    "discourse_journals.admin.mapping.analysis_paused_title"
                  }}</strong>
                <p>{{this.analysisMessage}}</p>
              </div>
            </div>
            <p class="mapping-paused-hint">{{i18n
                "discourse_journals.admin.mapping.analysis_paused_hint"
              }}</p>
          </div>
        {{/if}}

        {{! 其他消息（如启动失败等） }}
        {{#if this.analysisMessage}}
          {{#unless this.analyzing}}
            {{#unless this.analysisResult}}
              {{#unless this.analysisFailed}}
                {{#unless this.analysisPaused}}
                  <div class="message-box message-error">
                    {{this.analysisMessage}}
                  </div>
                {{/unless}}
              {{/unless}}
            {{/unless}}
          {{/unless}}
        {{/if}}

        {{! 分析结果 }}
        {{#if this.analysisResult}}
          <div class="mapping-summary">
            <div class="mapping-totals">
              <div class="mapping-total-item">
                <span
                  class="total-value"
                >{{this.analysisResult.total_forum_topics}}</span>
                <span class="total-label">{{i18n
                    "discourse_journals.admin.mapping.forum_topics"
                  }}</span>
              </div>
              <div class="mapping-total-item">
                <span
                  class="total-value"
                >{{this.analysisResult.total_api_records}}</span>
                <span class="total-label">{{i18n
                    "discourse_journals.admin.mapping.api_records"
                  }}</span>
              </div>
            </div>

            <div class="mapping-categories">
              <div
                class="mapping-cat-row clickable"
                role="button"
                {{on "click" (fn this.loadMappingDetails "exact_1to1")}}
              >
                <span class="cat-color cat-success"></span>
                <span class="cat-label">{{i18n
                    "discourse_journals.admin.mapping.exact_1to1"
                  }}</span>
                <span
                  class="cat-count"
                >{{this.analysisResult.exact_1to1}}</span>
                <div class="cat-bar-track">
                  <div
                    class="cat-bar-fill cat-bar-success"
                    style="width: {{this.mappingBarWidths.exact_1to1}}%"
                  ></div>
                </div>
              </div>

              <div
                class="mapping-cat-row clickable"
                role="button"
                {{on "click" (fn this.loadMappingDetails "forum_1_to_api_n")}}
              >
                <span class="cat-color cat-warning"></span>
                <span class="cat-label">{{i18n
                    "discourse_journals.admin.mapping.forum_1_to_api_n"
                  }}</span>
                <span
                  class="cat-count"
                >{{this.analysisResult.forum_1_to_api_n}}</span>
                <div class="cat-bar-track">
                  <div
                    class="cat-bar-fill cat-bar-warning"
                    style="width: {{this.mappingBarWidths.forum_1_to_api_n}}%"
                  ></div>
                </div>
              </div>

              <div
                class="mapping-cat-row clickable"
                role="button"
                {{on "click" (fn this.loadMappingDetails "forum_n_to_api_1")}}
              >
                <span class="cat-color cat-warning"></span>
                <span class="cat-label">{{i18n
                    "discourse_journals.admin.mapping.forum_n_to_api_1"
                  }}</span>
                <span
                  class="cat-count"
                >{{this.analysisResult.forum_n_to_api_1}}</span>
                <div class="cat-bar-track">
                  <div
                    class="cat-bar-fill cat-bar-warning"
                    style="width: {{this.mappingBarWidths.forum_n_to_api_1}}%"
                  ></div>
                </div>
              </div>

              <div
                class="mapping-cat-row clickable"
                role="button"
                {{on "click" (fn this.loadMappingDetails "forum_n_to_api_m")}}
              >
                <span class="cat-color cat-danger"></span>
                <span class="cat-label">{{i18n
                    "discourse_journals.admin.mapping.forum_n_to_api_m"
                  }}</span>
                <span
                  class="cat-count"
                >{{this.analysisResult.forum_n_to_api_m}}</span>
                <div class="cat-bar-track">
                  <div
                    class="cat-bar-fill cat-bar-danger"
                    style="width: {{this.mappingBarWidths.forum_n_to_api_m}}%"
                  ></div>
                </div>
              </div>

              <div
                class="mapping-cat-row clickable"
                role="button"
                {{on "click" (fn this.loadMappingDetails "forum_only")}}
              >
                <span class="cat-color cat-orphan"></span>
                <span class="cat-label">{{i18n
                    "discourse_journals.admin.mapping.forum_only"
                  }}</span>
                <span
                  class="cat-count"
                >{{this.analysisResult.forum_only}}</span>
                <div class="cat-bar-track">
                  <div
                    class="cat-bar-fill cat-bar-orphan"
                    style="width: {{this.mappingBarWidths.forum_only}}%"
                  ></div>
                </div>
              </div>

              <div
                class="mapping-cat-row clickable"
                role="button"
                {{on "click" (fn this.loadMappingDetails "api_only")}}
              >
                <span class="cat-color cat-new"></span>
                <span class="cat-label">{{i18n
                    "discourse_journals.admin.mapping.api_only"
                  }}</span>
                <span class="cat-count">{{this.analysisResult.api_only}}</span>
                <div class="cat-bar-track">
                  <div
                    class="cat-bar-fill cat-bar-new"
                    style="width: {{this.mappingBarWidths.api_only}}%"
                  ></div>
                </div>
              </div>
            </div>

            {{#if this.analysisResult.completed_at}}
              <p class="mapping-time">{{i18n
                  "discourse_journals.admin.mapping.completed_at"
                }}
                {{this.analysisResult.completed_at}}</p>
            {{/if}}
          </div>

          {{! 详情面板 }}
          {{#if this.showAnalysisDetails}}
            <div class="mapping-details-panel">
              <div class="details-header">
                <h4>{{this.analysisCategoryLabel}}
                  ({{this.analysisDetailsTotal}})</h4>
                <DButton
                  @class="btn-flat"
                  @action={{action "closeMappingDetails"}}
                  @icon="times"
                />
              </div>

              {{#if this.loadingDetails}}
                <div class="details-loading">{{i18n
                    "discourse_journals.admin.mapping.loading"
                  }}</div>
              {{else}}
                <div class="details-table-wrap">
                  <table class="mapping-details-table">
                    <thead>
                      <tr>
                        <th>{{i18n
                            "discourse_journals.admin.mapping.col_title"
                          }}</th>
                        {{#if this.isDetailsCategoryMatched}}
                          <th>{{i18n
                              "discourse_journals.admin.mapping.col_topic_id"
                            }}</th>
                          <th>{{i18n
                              "discourse_journals.admin.mapping.col_api_id"
                            }}</th>
                          <th>{{i18n
                              "discourse_journals.admin.mapping.col_issn_l"
                            }}</th>
                        {{/if}}
                        {{#if this.isDetailsCategoryForumOnly}}
                          <th>{{i18n
                              "discourse_journals.admin.mapping.col_topic_id"
                            }}</th>
                        {{/if}}
                        {{#if this.isDetailsCategoryApiOnly}}
                          <th>{{i18n
                              "discourse_journals.admin.mapping.col_api_id"
                            }}</th>
                          <th>{{i18n
                              "discourse_journals.admin.mapping.col_issn_l"
                            }}</th>
                        {{/if}}
                      </tr>
                    </thead>
                    <tbody>
                      {{#each this.analysisDetailsItems as |item|}}
                        <tr>
                          <td
                            class="detail-title"
                          >{{item.normalized_title}}</td>
                          {{#if item.forum}}
                            <td>
                              {{#each item.forum as |f|}}
                                <a
                                  href="/t/{{f.topic_id}}"
                                  target="_blank"
                                >{{f.topic_id}}</a>
                              {{/each}}
                            </td>
                          {{/if}}
                          {{#if item.api}}
                            <td>
                              {{#each item.api as |a|}}
                                <span class="api-id-badge">{{a.api_id}}</span>
                              {{/each}}
                            </td>
                            <td>
                              {{#each item.api as |a|}}
                                <span>{{a.issn_l}}</span>
                              {{/each}}
                            </td>
                          {{/if}}
                        </tr>
                      {{/each}}
                    </tbody>
                  </table>
                </div>

                {{#if this.hasMultipleDetailsPages}}
                  <div class="details-pagination">
                    <DButton
                      @class="btn-default btn-small"
                      @action={{action "prevDetailsPage"}}
                      @icon="chevron-left"
                      @disabled={{this.prevDetailsPageDisabled}}
                    />
                    <span class="page-info">{{this.analysisDetailsPage}}
                      /
                      {{this.analysisDetailsTotalPages}}</span>
                    <DButton
                      @class="btn-default btn-small"
                      @action={{action "nextDetailsPage"}}
                      @icon="chevron-right"
                      @disabled={{this.nextDetailsPageDisabled}}
                    />
                  </div>
                {{/if}}
              {{/if}}
            </div>
          {{/if}}
        {{/if}}
      </div>
    </section>

    {{! ═══ Phase 2: 应用映射 ═══ }}
    {{#if this.analysisResult}}
      <section class="journals-section apply-section">
        <div class="section-header">
          <h3>{{i18n "discourse_journals.admin.mapping.apply_heading"}}</h3>
          <div class="header-actions apply-task-controls">
            {{#if this.applying}}
              <DButton
                @class="btn-danger"
                @action={{action "pauseApplyMapping"}}
                @label="discourse_journals.admin.mapping.apply_pause"
                @icon="pause"
                @isLoading={{this.applyPausing}}
                @disabled={{this.applyPausing}}
              />
            {{else}}
              {{#if this.canStartApply}}
                <DButton
                  @class="btn-primary"
                  @action={{action "startApplyMapping"}}
                  @label="discourse_journals.admin.mapping.apply_start"
                  @icon="check-double"
                />
              {{/if}}

              {{#if this.canResumeApply}}
                <DButton
                  @class="btn-primary"
                  @action={{action "resumeApplyMapping"}}
                  @label="discourse_journals.admin.mapping.apply_resume"
                  @icon="play"
                />
              {{/if}}

              {{#if this.canResetApply}}
                <DButton
                  @class="btn-default"
                  @action={{action "resetApplyMapping"}}
                  @label="discourse_journals.admin.mapping.apply_reset"
                  @icon="redo"
                />
              {{/if}}
            {{/if}}
          </div>
        </div>

        <div class="section-content">
          <p class="apply-desc">{{i18n
              "discourse_journals.admin.mapping.apply_description"
            }}</p>

          {{! 应用进行中 }}
          {{#if this.applying}}
            <div class="mapping-apply-progress">
              <div class="progress-container">
                <div class="progress-track">
                  <div
                    class="progress-fill"
                    style="width: {{this.applyProgress}}%"
                  ></div>
                </div>
                <span class="progress-percent">{{this.applyProgress}}%</span>
              </div>
              <p class="progress-status">{{this.applyMessage}}</p>
              {{#if this.applyStats}}
                <div class="stats-grid apply-stats-grid">
                  {{#if this.applyStats.deleted}}
                    <div class="stat-item stat-error">
                      <span
                        class="stat-value"
                      >{{this.applyStats.deleted}}</span>
                      <span class="stat-label">{{i18n
                          "discourse_journals.admin.mapping.apply_stats_deleted"
                        }}</span>
                    </div>
                  {{/if}}
                  <div class="stat-item stat-info">
                    <span class="stat-value">{{this.applyStats.updated}}</span>
                    <span class="stat-label">{{i18n
                        "discourse_journals.admin.mapping.apply_stats_updated"
                      }}</span>
                  </div>
                  <div class="stat-item stat-success">
                    <span class="stat-value">{{this.applyStats.created}}</span>
                    <span class="stat-label">{{i18n
                        "discourse_journals.admin.mapping.apply_stats_created"
                      }}</span>
                  </div>
                  {{#if this.applyStats.errors}}
                    <div class="stat-item stat-warning">
                      <span class="stat-value">{{this.applyStats.errors}}</span>
                      <span class="stat-label">{{i18n
                          "discourse_journals.admin.mapping.apply_stats_errors"
                        }}</span>
                    </div>
                  {{/if}}
                </div>
              {{/if}}
            </div>
          {{/if}}

          {{! 应用完成 }}
          {{#if this.applyCompleted}}
            <div class="message-box message-success mapping-apply-result">
              <strong>{{i18n
                  "discourse_journals.admin.mapping.apply_completed"
                }}</strong>
              {{#if this.applyStats}}
                <p>{{i18n
                    "discourse_journals.admin.mapping.apply_stats_deleted"
                  }}:
                  {{this.applyStats.deleted}},
                  {{i18n
                    "discourse_journals.admin.mapping.apply_stats_updated"
                  }}:
                  {{this.applyStats.updated}},
                  {{i18n
                    "discourse_journals.admin.mapping.apply_stats_created"
                  }}:
                  {{this.applyStats.created}}</p>
              {{/if}}
            </div>
          {{/if}}

          {{! 应用失败 }}
          {{#if this.applyFailed}}
            <div class="message-box message-error mapping-apply-result">
              <strong>{{i18n
                  "discourse_journals.admin.mapping.apply_failed"
                }}</strong>
              <p>{{this.applyMessage}}</p>
              {{#if this.applyStats}}
                <div class="stats-grid apply-stats-grid stats-grid-inline">
                  {{#if this.applyStats.deleted}}
                    <div class="stat-item stat-error">
                      <span
                        class="stat-value"
                      >{{this.applyStats.deleted}}</span>
                      <span class="stat-label">{{i18n
                          "discourse_journals.admin.mapping.apply_stats_deleted"
                        }}</span>
                    </div>
                  {{/if}}
                  <div class="stat-item stat-info">
                    <span class="stat-value">{{this.applyStats.updated}}</span>
                    <span class="stat-label">{{i18n
                        "discourse_journals.admin.mapping.apply_stats_updated"
                      }}</span>
                  </div>
                  <div class="stat-item stat-success">
                    <span class="stat-value">{{this.applyStats.created}}</span>
                    <span class="stat-label">{{i18n
                        "discourse_journals.admin.mapping.apply_stats_created"
                      }}</span>
                  </div>
                </div>
              {{/if}}
            </div>
          {{/if}}

          {{! 应用已暂停 }}
          {{#if this.applyPaused}}
            <div class="message-box message-warning mapping-apply-result">
              <strong>{{i18n
                  "discourse_journals.admin.mapping.apply_paused_title"
                }}</strong>
              <p>{{this.applyMessage}}</p>
              {{#if this.applyStats}}
                <div class="stats-grid apply-stats-grid stats-grid-inline">
                  {{#if this.applyStats.deleted}}
                    <div class="stat-item stat-error">
                      <span
                        class="stat-value"
                      >{{this.applyStats.deleted}}</span>
                      <span class="stat-label">{{i18n
                          "discourse_journals.admin.mapping.apply_stats_deleted"
                        }}</span>
                    </div>
                  {{/if}}
                  <div class="stat-item stat-info">
                    <span class="stat-value">{{this.applyStats.updated}}</span>
                    <span class="stat-label">{{i18n
                        "discourse_journals.admin.mapping.apply_stats_updated"
                      }}</span>
                  </div>
                  <div class="stat-item stat-success">
                    <span class="stat-value">{{this.applyStats.created}}</span>
                    <span class="stat-label">{{i18n
                        "discourse_journals.admin.mapping.apply_stats_created"
                      }}</span>
                  </div>
                </div>
              {{/if}}
            </div>
          {{/if}}
        </div>
      </section>
    {{/if}}

    {{! ═══ 危险操作 ═══ }}
    <section class="journals-section danger-section">
      <div class="section-header">
        <h3>{{i18n "discourse_journals.admin.danger.heading"}}</h3>
      </div>
      <div class="section-content">
        <div class="danger-action">
          <div class="danger-info">
            <span class="danger-title">{{i18n
                "discourse_journals.admin.danger.delete_all_title"
              }}</span>
            <span class="danger-desc">{{i18n
                "discourse_journals.admin.danger.delete_all_desc"
              }}</span>
          </div>
          <DButton
            @class="btn-danger"
            @action={{action "deleteAllJournals"}}
            @label="discourse_journals.admin.danger.delete_all"
            @icon="trash-alt"
            @isLoading={{this.deleting}}
            @disabled={{this.deleteDisabled}}
          />
        </div>

        {{#if this.showDeleteProgress}}
          <div class="delete-progress-section">
            <div class="progress-container">
              <div class="progress-track">
                <div
                  class="progress-fill progress-danger"
                  style="width: {{this.deleteProgress}}%"
                ></div>
              </div>
              <span class="progress-percent">{{this.deleteProgress}}%</span>
              {{#if this.deleteEta}}
                <span class="progress-eta">{{i18n
                    "discourse_journals.admin.danger.eta_prefix"
                  }}
                  {{this.deleteEta}}</span>
              {{/if}}
            </div>

            <p class="progress-status">{{this.deleteMessage}}</p>

            {{#if this.deleteStats}}
              <div class="stats-grid">
                <div class="stat-item">
                  <span class="stat-value">{{this.deleteStats.deleted}}</span>
                  <span class="stat-label">{{i18n
                      "discourse_journals.admin.danger.deleted_of"
                    }}
                    {{this.deleteStats.total}}</span>
                </div>
                {{#if (gt this.deleteStats.errors 0)}}
                  <div class="stat-item stat-error">
                    <span class="stat-value">{{this.deleteStats.errors}}</span>
                    <span class="stat-label">{{i18n
                        "discourse_journals.admin.danger.delete_errors_label"
                      }}</span>
                  </div>
                {{/if}}
              </div>
            {{/if}}
          </div>
        {{else if this.deleteMessage}}
          <div
            class="message-box
              {{if this.deleteSuccess 'message-success' 'message-error'}}"
          >
            {{this.deleteMessage}}
          </div>
        {{/if}}
      </div>
    </section>
  </div>
</div>