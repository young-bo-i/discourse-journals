<div class="admin-container journals-admin-page">
  <div class="journals-header">
    <h2>{{i18n "discourse_journals.admin.heading"}}</h2>
    <p class="journals-subtitle">从外部 API 同步期刊数据到 Discourse</p>
  </div>

  <div class="journals-main">
    {{! API 配置区域 }}
    <section class="journals-section">
      <div class="section-header">
        <h3>API 配置</h3>
      </div>
      <div class="section-content">
        <div class="form-row">
          <label class="form-label">API 地址</label>
          <div class="form-input-group">
            <input
              type="text"
              {{on "input" this.updateApiUrl}}
              value={{this.apiUrl}}
              placeholder="https://api.example.com"
              class="form-input"
            />
            <DButton
              @class="btn-default"
              @action={{action "testConnection"}}
              @label="discourse_journals.admin.sync.test_connection"
              @icon="link"
              @isLoading={{this.testing}}
              @disabled={{this.syncing}}
            />
          </div>
          <p class="form-hint">
            可在 <a href="/admin/site_settings/category/plugins?filter=journals">站点设置</a> 中配置默认地址
          </p>
        </div>

        {{#if this.testMessage}}
          <div class="message-box {{if this.testSuccess 'message-success' 'message-error'}}">
            {{this.testMessage}}
          </div>
        {{/if}}
      </div>
    </section>

    {{! 筛选条件 }}
    <section class="journals-section collapsible">
      <div class="section-header clickable" role="button" {{on "click" this.toggleFilters}}>
        <h3>筛选条件</h3>
        <span class="toggle-icon">{{if this.showFilters "−" "+"}}</span>
      </div>
      
      {{#if this.showFilters}}
        <div class="section-content">
          <div class="filters-grid">
            <div class="form-field">
              <label>搜索关键词</label>
              <input
                type="text"
                {{on "input" this.updateFilterQ}}
                value={{this.filterQ}}
                placeholder="ISSN、标题、出版商..."
              />
            </div>

            <div class="form-field">
              <label>DOAJ 收录</label>
              <select {{on "change" this.updateFilterInDoaj}} value={{this.filterInDoaj}}>
                <option value="">全部</option>
                <option value="true">是</option>
                <option value="false">否</option>
              </select>
            </div>

            <div class="form-field">
              <label>NLM 收录</label>
              <select {{on "change" this.updateFilterInNlm}} value={{this.filterInNlm}}>
                <option value="">全部</option>
                <option value="true">是</option>
                <option value="false">否</option>
              </select>
            </div>

            <div class="form-field">
              <label>Wikidata 记录</label>
              <select {{on "change" this.updateFilterHasWikidata}} value={{this.filterHasWikidata}}>
                <option value="">全部</option>
                <option value="true">有</option>
                <option value="false">无</option>
              </select>
            </div>

            <div class="form-field">
              <label>开放获取</label>
              <select {{on "change" this.updateFilterIsOpenAccess}} value={{this.filterIsOpenAccess}}>
                <option value="">全部</option>
                <option value="true">是</option>
                <option value="false">否</option>
              </select>
            </div>
          </div>

          <div class="filter-footer">
            {{#if this.hasActiveFilters}}
              <span class="filter-badge">已应用 {{this.activeFiltersCount}} 个筛选</span>
            <DButton
              @class="btn-flat"
              @action={{action "clearFilters"}}
              @label="discourse_journals.admin.sync.clear"
              @icon="times"
            />
            {{else}}
              <span class="filter-hint">未设置筛选条件</span>
            {{/if}}
          </div>
        </div>
      {{/if}}
    </section>

    {{! 导入操作 }}
    <section class="journals-section">
      <div class="section-header">
        <h3>数据导入</h3>
      </div>
      <div class="section-content">
        <div class="import-actions">
          <div class="import-action-card">
            <div class="action-info">
              <span class="action-title">测试导入</span>
              <span class="action-desc">导入第一页数据（约 100 条），用于验证配置</span>
            </div>
            <DButton
              @class="btn-primary"
              @action={{action "syncFirstPage"}}
              @label="discourse_journals.admin.sync.start_test"
              @icon="flask"
              @isLoading={{this.syncing}}
              @disabled={{this.syncing}}
            />
          </div>

          <div class="import-action-card">
            <div class="action-info">
              <span class="action-title">完整导入</span>
              <span class="action-desc">导入所有期刊数据，可能需要较长时间</span>
            </div>
            <DButton
              @class="btn-primary"
              @action={{action "syncAllPages"}}
              @label="discourse_journals.admin.sync.start_import"
              @icon="database"
              @isLoading={{this.syncing}}
              @disabled={{this.syncing}}
            />
          </div>
        </div>
      </div>
    </section>

    {{! 进度显示 }}
    {{#if this.showProgress}}
      <section class="journals-section progress-section">
        <div class="section-header">
          <h3>导入进度</h3>
          <div class="header-actions">
            {{#if this.canPause}}
              <DButton
                @class="btn-default"
                @action={{action "pauseImport"}}
                @label="discourse_journals.admin.sync.pause"
                @icon="pause"
                @isLoading={{this.pausing}}
              />
            {{/if}}
            {{#if this.canResume}}
              <DButton
                @class="btn-primary"
                @action={{action "resumeImport"}}
                @label="discourse_journals.admin.sync.resume"
                @icon="play"
                @isLoading={{this.resuming}}
              />
            {{/if}}
          </div>
        </div>
        <div class="section-content">
          <div class="progress-container">
            <div class="progress-track">
              <div class="progress-fill" style="width: {{this.progress}}%"></div>
            </div>
            <span class="progress-percent">{{this.progress}}%</span>
          </div>
          
          <p class="progress-status">{{this.progressMessage}}</p>

          {{#if this.importStats}}
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-value">{{this.importStats.processed}}</span>
                <span class="stat-label">已处理 / {{this.importStats.total}}</span>
              </div>
              <div class="stat-item stat-success">
                <span class="stat-value">{{this.importStats.created}}</span>
                <span class="stat-label">新建</span>
              </div>
              <div class="stat-item stat-info">
                <span class="stat-value">{{this.importStats.updated}}</span>
                <span class="stat-label">更新</span>
              </div>
              {{#if (gt this.importStats.skipped 0)}}
                <div class="stat-item stat-warning">
                  <span class="stat-value">{{this.importStats.skipped}}</span>
                  <span class="stat-label">跳过</span>
                </div>
              {{/if}}
              {{#if (gt this.importStats.errors 0)}}
                <div class="stat-item stat-error">
                  <span class="stat-value">{{this.importStats.errors}}</span>
                  <span class="stat-label">错误</span>
                </div>
              {{/if}}
            </div>
          {{/if}}
        </div>
      </section>
    {{/if}}

    {{! 结果消息 }}
    {{#if this.importMessage}}
      <div class="message-box {{if this.importSuccess 'message-success' 'message-error'}}">
        {{this.importMessage}}
      </div>
    {{/if}}

    {{! 错误日志 }}
    {{#if (gt this.errors.length 0)}}
      <section class="journals-section error-section">
        <div class="section-header">
          <h3>错误日志 <span class="error-count">({{this.errors.length}})</span></h3>
          <div class="header-actions">
            <DButton
              @class="btn-flat"
              @action={{action "toggleErrors"}}
              @label={{if this.showErrors "discourse_journals.admin.errors.collapse" "discourse_journals.admin.errors.expand"}}
              @icon={{if this.showErrors "angle-up" "angle-down"}}
            />
            <DButton
              @class="btn-flat"
              @action={{action "copyErrors"}}
              @label="discourse_journals.admin.errors.copy"
              @icon="copy"
            />
          </div>
        </div>

        {{#if this.showErrors}}
          <div class="section-content">
            <div class="errors-list">
              {{#each this.errors as |error index|}}
                <div class="error-item">
                  <span class="error-index">{{add index 1}}</span>
                  <div class="error-content">
                    <p class="error-message">{{error.message}}</p>
                    {{#if error.details}}
                      <pre class="error-details">{{error.details}}</pre>
                    {{/if}}
                  </div>
                </div>
              {{/each}}
            </div>
          </div>
        {{/if}}
      </section>
    {{/if}}

    {{! 帮助信息 }}
    <section class="journals-section help-section">
      <div class="section-header">
        <h3>使用说明</h3>
      </div>
      <div class="section-content">
        <ul class="help-list">
          <li>首次导入建议先使用「测试导入」验证配置是否正确</li>
          <li>导入过程会自动创建或更新期刊话题，不会产生重复数据</li>
          <li>如果数据处理失败（如缺少必要字段），该期刊会被跳过</li>
          <li>导入在后台运行，可以安全关闭此页面</li>
        </ul>
      </div>
    </section>

    {{! 危险操作 }}
    <section class="journals-section danger-section">
      <div class="section-header">
        <h3>危险操作</h3>
      </div>
      <div class="section-content">
        <div class="danger-action">
          <div class="danger-info">
            <span class="danger-title">删除所有期刊</span>
            <span class="danger-desc">永久删除所有导入的期刊帖子，此操作不可撤销</span>
          </div>
          <DButton
            @class="btn-danger"
            @action={{action "deleteAllJournals"}}
            @label="discourse_journals.admin.danger.delete_all"
            @icon="trash-alt"
            @isLoading={{this.deleting}}
            @disabled={{this.syncing}}
          />
        </div>

        {{#if this.deleteMessage}}
          <div class="message-box {{if this.deleteSuccess 'message-success' 'message-error'}}">
            {{this.deleteMessage}}
          </div>
        {{/if}}
      </div>
    </section>
  </div>
</div>
